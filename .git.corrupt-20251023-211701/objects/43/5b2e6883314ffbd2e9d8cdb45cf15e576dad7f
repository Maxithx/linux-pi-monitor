# routes/drivers/os_detect.py
from __future__ import annotations
import re
from typing import Tuple, Dict

from routes.common.ssh_utils import ssh_connect, ssh_exec
from routes.settings import _get_active_ssh_settings, _is_configured


def _active_settings() -> dict:
    s = _get_active_ssh_settings()
    if not _is_configured(s):
        raise RuntimeError("SSH not configured")
    return s


def _read_os_release_text() -> str:
    s = _active_settings()
    ssh = ssh_connect(
        host=s["pi_host"], user=s["pi_user"],
        auth=s.get("auth_method", "key"),
        key_path=s.get("ssh_key_path", ""),
        password=s.get("password", ""), timeout=20
    )
    rc, out, _ = ssh_exec(ssh, 'sh -lc "cat