{% extends "base.html" %}
{% block title %}Updates{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/updates.css') }}">
<div class="container" style="padding: 22px 24px; color: #eaeaea;">
    <h1 style="margin:0 0 14px;">Software Updates</h1>

    <!-- Status + Connection (no shortcuts) -->
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-bottom:16px;">
        <!-- Status -->
        <div class="card" style="background:#121421; border-radius:10px; padding:16px;">
            <div style="display:flex; align-items:center; justify-content:space-between;">
                <div style="font-weight:600;">Status</div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button id="btn-refresh" class="btn small" title="Refresh">⟳</button>
                </div>
            </div>

            <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <span id="badge-conn" class="badge green">Connected</span>
                <span id="badge-reboot" class="badge warn" style="display:none;">Reboot now</span>
                <button id="btn-reboot" class="btn warn small" disabled>Reboot now</button>
            </div>

            <div style="margin-top:8px; opacity:.8; font-size:.95rem;">
                Run the checks below to see available updates.
            </div>
        </div>

        <!-- Connection (user@host + OS) -->
        <div class="card" style="background:#121421; border-radius:10px; padding:16px;">
            <div style="font-weight:600; margin-bottom:10px;">Connection</div>
            <div id="conn-line" style="display:flex; flex-direction:column; gap:6px; font-size:.95rem;">
                <div id="conn-userhost" style="opacity:.95;">Connected</div>
                <div id="conn-os" style="opacity:.8;"></div>
            </div>
            <div style="margin-top:10px; opacity:.7; font-size:.9rem;">
                Updates run over SSH using your selected profile.
            </div>
        </div>
    </div>

    <!-- Primary action -->
    <div class="card" style="background:#121421; border-radius:10px; padding:14px; margin-bottom:14px;">
        <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;">
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn success" data-action="full_noob_update"
                    title="apt full-upgrade + cleanup + Flatpak/Snap + reboot check">
                    Full Update (Recommended)
                </button>
            </div>

            <div>
                <button id="btn-install-security" class="btn" disabled>Install security updates</button>
                <button id="btn-install-all" class="btn" disabled>Install all updates</button>
                <button id="btn-toggle-advanced" class="btn ghost">Show advanced options</button>
            </div>
        </div>

        <!-- Advanced options -->
        <div id="advanced-actions" style="display:none; margin-top:12px;">
            <div style="opacity:.85; font-size:.95rem; margin-bottom:8px;">Advanced maintenance:</div>
            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                <!-- CHECK -->
                <button class="btn" data-action="apt_update">APT: Update index</button>
                <button class="btn" data-action="apt_list">APT: List upgradable</button>
                <button class="btn" data-action="apt_dry_full">APT: Dry-run full-upgrade</button>

                <!-- APPLY -->
                <button class="btn" data-action="apt_upgrade">Apply (safe upgrade)</button>
                <button class="btn warn" data-action="apt_full_upgrade">Apply (full upgrade)</button>

                <!-- FLATPAK -->
                <button class="btn" data-action="flatpak_dry">Flatpak: Dry-run</button>
                <button class="btn" data-action="flatpak_apply">Flatpak: Update</button>

                <!-- SNAP -->
                <button class="btn" data-action="snap_list">Snap: List</button>
                <button class="btn" data-action="snap_refresh">Snap: Refresh</button>

                <!-- DOCKER -->
                <button class="btn" data-action="docker_ps">Docker: Running</button>
            </div>
        </div>
    </div>

    <!-- Output: moved UP under primary actions -->
    <div class="card" style="background:#0f111b; border-radius:10px; padding:0; overflow:hidden; margin-bottom:14px;">
        <div style="padding:12px 14px; border-bottom:1px solid #22263a; font-weight:600;">Output</div>
        <pre id="out"
            style="margin:0; padding:14px; max-height:420px; overflow:auto; background:#0b0d17; color:#e0e0e0; font-family:'Cascadia Mono', 'Fira Code', Consolas, monospace; font-size:13px; white-space:pre-wrap;"></pre>
    </div>

    <!-- Available updates -->
    <div class="card" style="background:#121421; border-radius:10px; padding:14px; margin-bottom:14px;">
        <div style="display:flex; align-items:center; justify-content:space-between;">
            <div style="font-weight:600; display:flex; align-items:center; gap:10px;">
                <span>Available updates</span>
                <!-- Count badge -->
                <span id="updates-count" class="badge" style="display:none;"></span>
            </div>

            <div id="search-indicator" class="search-indicator" style="display:none;">
                <span class="spinner"></span>
                <span id="search-text">Searching for updates…</span>
                <span id="search-timer">(0s)</span>
            </div>
        </div>
        <div id="updates-table" style="margin-top:10px;">
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr>
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #22263a;">Name</th>
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #22263a;">Version</th>
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #22263a;">Severity</th>
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #22263a;">Details</th>
                        <!-- NEW: per-package install progress -->
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #22263a;">Installing
                            Update</th>
                    </tr>
                </thead>
                <tbody id="updates-body"></tbody>
            </table>
            <div id="updates-empty" style="display:none; opacity:.8; padding:12px;">No updates available.</div>
        </div>
    </div>

    <!-- Notes -->
    <div id="apt-warning-note" class="card"
        style="display:none; background:#14192b; border-radius:10px; padding:12px; margin-bottom:14px;">
        <div style="font-weight:600; margin-bottom:6px;">About the APT warning</div>
        <div style="opacity:.9; font-size:.95rem; line-height:1.45;">
            You may see: <code>apt does not have a stable CLI interface. Use with caution in scripts.</code><br>
            This is a standard informational message when <strong>apt</strong> is used non-interactively. It is
            <strong>not an error</strong>.
        </div>
    </div>

    <div id="phasing-note" class="card"
        style="display:none; background:#122016; border-radius:10px; padding:12px; margin-bottom:14px;">
        <div style="font-weight:600; margin-bottom:6px;">Why an update may be “deferred”</div>
        <div style="opacity:.9; font-size:.95rem; line-height:1.45%;">
            Some Ubuntu/Mint updates are rolled out in <strong>phases</strong>. If you see “deferred due to phasing”, it
            usually resolves in a few days.
        </div>
    </div>

    <!-- Help -->
    <div class="card" style="background:#121421; border-radius:10px; padding:0; overflow:hidden;">
        <details>
            <summary style="list-style:none; padding:14px; cursor:pointer; user-select:none;">
                <span style="font-weight:600;">What do these buttons do?</span>
            </summary>
            <div style="padding:14px; border-top:1px solid #22263a; line-height:1.5; opacity:.95;">
                <ul style="margin-left: 18px;">
                    <li><strong>Full Update:</strong> apt full-upgrade + cleanup, then Flatpak/Snap updates.</li>
                    <li><strong>Security updates:</strong> installs only packages flagged as security.</li>
                    <li><strong>Install all:</strong> applies all available updates.</li>
                </ul>
            </div>
        </details>
    </div>
</div>

<script defer src="{{ url_for('static', filename='js/updates.js') }}"></script>
{% endblock %}