{% extends "base.html" %}

{% block title %}Settings{% endblock %}
{% block page_title %}Raspberry Pi Settings{% endblock %}

{% block content %}
<h1 style="margin-bottom: 20px;">Settings</h1>

<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">

{% set conn_ready =
(settings.pi_host and settings.pi_user) and
((settings.auth_method=='key' and settings.ssh_key_path) or
(settings.auth_method=='password' and (settings.password or '')))
%}

<div class="container" id="settings-root" data-active-profile="{{ active_profile_id|default('') }}">

    <!-- ====== SSH PROFILES (unchanged) ====== -->
    <h2 style="margin-bottom:6px">SSH Profiles <span class="pill muted">beta</span></h2>
    <div class="profiles-bar">
        <select id="ssh_profile_select" class="grow" aria-label="Select SSH profile">
            <option value="__none__" selected disabled>Loading profiles‚Ä¶</option>
        </select>
        <button id="btn-new-profile" class="secondary">New</button>
        <button id="btn-duplicate-profile" class="secondary">Duplicate</button>
        <button id="btn-rename-profile" class="secondary">Rename</button>
        <button id="btn-delete-profile" class="danger">Delete</button>
        <button id="btn-test-profile" class="secondary">Test</button>
        <button id="btn-save-profile" class="primary">Save profile</button>
    </div>

    <div class="muted" style="margin:-2px 0 16px">
        Tip: Create profiles for both Linux and Raspberry Pi. When you switch from the dropdown, the fields below
        update.
    </div>

    <!-- ====== CONNECTION STATUS ====== -->
    <div id="ssh-connection" class="status-line" aria-live="polite" aria-atomic="true">
        <span id="ssh-conn-dot" class="dot dot-red" aria-hidden="true"></span>
        <span id="ssh-conn-text">No connection to Linux</span>
        <span id="ssh-conn-spinner" class="spinner" style="display:none;"></span>
        <span id="ssh-conn-hint" class="hint"></span>
    </div>

    {% if not conn_ready %}
    <div class="alert alert-warning" style="margin-top:10px;">
        ‚ö†Ô∏è Complete your SSH connection settings (Host, Username and
        {% if settings.auth_method == 'password' %}Password{% else %}SSH Key Path{% endif %})
        to enable Glances and software actions.
    </div>
    {% endif %}

    {% if request.args.get('saved') == 'true' %}
    <div class="alert alert-success" id="saved-alert">‚úîÔ∏è Settings saved</div>
    {% elif request.args.get('reset') == 'true' %}
    <div class="alert alert-info" id="reset-alert">üîÑ Settings reset</div>
    {% endif %}

    {% if request.args.get('status') == 'success' %}
    <div class="alert alert-success" id="status-alert">‚úÖ Connection to Linux verified!</div>
    {% elif request.args.get('status') == 'fail' %}
    <div class="alert alert-danger" id="status-alert">‚ùå Connection failed. Please check your settings.</div>
    {% elif request.args.get('status') == 'already' %}
    <div class="alert alert-info" id="status-alert">‚ÑπÔ∏è Already connected.</div>
    {% endif %}

    <!-- ====== SSH FORM (unchanged) ====== -->
    <form id="save-form" onsubmit="return false;">
        <input type="hidden" id="profile_id" name="profile_id" value="" />
        <label for="pi_host">Pi Host</label>
        <input type="text" id="pi_host" name="pi_host" value="{{ settings.pi_host }}">
        <label for="pi_user">Pi Username</label>
        <input type="text" id="pi_user" name="pi_user" value="{{ settings.pi_user }}">
        <label for="auth_method">Authentication Method</label>
        <select id="auth_method" name="auth_method">
            <option value="key" {% if settings.auth_method=='key' %}selected{% endif %}>SSH Key</option>
            <option value="password" {% if settings.auth_method=='password' %}selected{% endif %}>Password</option>
        </select>

        <div id="key_fields" {% if settings.auth_method!='key' %}style="display:none" {% endif %}>
            <label for="ssh_key_path">SSH Key Path</label>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <input type="text" id="ssh_key_path" name="ssh_key_path" class="grow"
                    value="{{ settings.ssh_key_path }}">
                <button id="btn-gen-key" class="secondary" type="button">Generate key</button>
                <button id="btn-install-key" class="secondary" type="button">Install key on host</button>
                <button id="btn-ssh-help" class="secondary" type="button" style="margin-left:8px;">SSH setup
                    help</button>
            </div>
            <div class="muted" style="margin-top:6px">
                Tip: Keys are created as <code>~/.ssh/id_&lt;profilename&gt;</code> (ed25519). ‚ÄúInstall key‚Äù appends the
                public
                key to <code>~/.ssh/authorized_keys</code> on the selected host.
            </div>
        </div>

        <div id="password_field" {% if settings.auth_method!='password' %}style="display:none" {% endif %}>
            <label for="password">Password</label>
            <input type="password" id="password" name="password" value="{{ settings.password or '' }}">
        </div>

        <button id="clear-fields-btn" class="secondary" type="button" style="margin:10px 0;">Clear fields</button>
    </form>

    <hr>

    <!-- ====== GLANCES ====== -->
    <div style="margin-top:20px;">
        <h2>Glances System Monitor</h2>
        <p style="color:#ccc; margin-bottom:10px;">
            <strong>What is Glances?</strong> Glances is an advanced system monitoring tool that provides live stats for
            CPU,
            RAM, disk, and network on your Raspberry Pi. It‚Äôs required for the <strong>Live System (Glances)</strong>
            page to work.
        </p>

        <div id="glances-status-box" style="margin-bottom:10px;">
            <span id="glances-status-text" style="color: yellow;">Fetching status...</span>
        </div>

        <div id="installing-text" style="color: lightgreen; display:none; margin:10px 0;">
            <span class="spinner"></span> Installing Glances‚Ä¶ <span id="install-timer">00:00</span>
        </div>

        <!-- Buttons row -->
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">

            <button id="install-glances-btn" {% if not conn_ready %}disabled title="Complete SSH settings first" {%
                endif %}>
                Install Glances
            </button>

            <!-- New: systemd dropdown button -->
            <div class="dropdown" style="position:relative; display:inline-block;">
                <button id="glances-systemd-btn" class="secondary" {% if not conn_ready %}disabled
                    title="Complete SSH settings first" {% endif %}>
                    Glances systemd ‚ñæ
                </button>
                <div id="glances-systemd-menu" class="dropdown-menu"
                    style="display:none; position:absolute; z-index:5; min-width:190px; background:#1e1e1e; border:1px solid #333; border-radius:6px; padding:6px;">
                    <button class="menu-item" data-action="start" style="width:100%;">Start / Restart</button>
                    <button class="menu-item" data-action="stop" style="width:100%;">Stop</button>
                    <button class="menu-item" data-action="status" style="width:100%;">Show status</button>
                </div>
            </div>

            <button id="view-glances-log-btn" {% if not conn_ready %}disabled title="Complete SSH settings first" {%
                endif %}>
                View Glances Log
            </button>

            <button id="uninstall-glances" class="uninstall-button" {% if not conn_ready %}disabled
                title="Complete SSH settings first" {% endif %}>
                Uninstall Glances
            </button>

            <button id="clear-glances-log-btn" class="secondary">Clear log</button>
        </div>

        <p style="margin-top:10px; color:orange; font-size:14px;">
            If you uninstall Glances and its dependencies, the <strong>Live System (Glances)</strong> page will stop
            working.
        </p>

        <pre id="glances-output" class="logbox"
            style="background:#000; color:#0f0; padding:10px; display:none; margin-top:10px;"></pre>
        <pre id="glances-service-output" class="logbox"
            style="background:#000; color:#0f0; padding:10px; display:none; margin-top:10px;"></pre>
        <pre id="glances-log-output" class="logbox"
            style="background:#111; color:#0f0; padding:10px; display:none; margin-top:10px;"></pre>
    </div>

    <hr>

    <!-- Terminal software (unchanged) -->
    <h3 style="margin-top:20px;">Terminal Software</h3>
    <p>Install or remove optional programs on your Raspberry Pi:</p>
    <div class="software-grid-box">
        <table class="software-table">
            <thead>
                <tr>
                    <th colspan="4">Software Installation Status</th>
                </tr>
                <tr>
                    <th>#</th>
                    <th>Software</th>
                    <th>Installed</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1.</td>
                    <td>Neofetch</td>
                    <td><span id="status-neofetch">Loading...</span></td>
                    <td>
                        <button id="install-neofetch-btn" {% if not conn_ready %}disabled
                            title="Complete SSH settings first" {% endif %}>Install</button>
                        <button id="uninstall-neofetch-btn" {% if not conn_ready %}disabled
                            title="Complete SSH settings first" {% endif %}>Uninstall</button>
                    </td>
                </tr>
                <tr>
                    <td>2.</td>
                    <td>CMatrix</td>
                    <td><span id="status-cmatrix">Loading...</span></td>
                    <td>
                        <button id="install-cmatrix-btn" {% if not conn_ready %}disabled
                            title="Complete SSH settings first" {% endif %}>Install</button>
                        <button id="uninstall-cmatrix-btn" {% if not conn_ready %}disabled
                            title="Complete SSH settings first" {% endif %}>Uninstall</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

</div>

<div id="terminal-software-spinner" style="display:none; margin-top:10px; color: lightgreen;">
    <span class="spinner"></span> Installing‚Ä¶ this may take up to 1 minute before output appears.
</div>

<pre id="terminal-software-output" class="logbox"
    style="display:none; background:#000; color:#0f0; padding:10px; margin-top:10px; font-family:monospace;"></pre>

<!-- SSH help modal (unchanged) -->
<div id="sshSetupModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="sshSetupTitle">
    <div class="modal-card">
        <div class="modal-header">
            <h5 class="modal-title" id="sshSetupTitle">Enable SSH on Linux (Debian/Ubuntu/Mint)</h5>
            <button type="button" class="btn-close" id="sshSetupClose" aria-label="Close">√ó</button>
        </div>
        <div class="modal-body">
            <p>Run these commands on <code id="sshHelpHost">your-host</code> as <code id="sshHelpUser">your-user</code>:
            </p>
            <pre id="sshHelpCommands" class="modal-pre"></pre>
            <p style="margin-top:8px;">After installation, click <em>Install key on host</em> here in Settings to enable
                key login.</p>
        </div>
        <div class="modal-footer" style="display:flex; gap:8px; justify-content:flex-end;">
            <button type="button" class="btn btn-outline" id="sshHelpCopy">Copy all</button>
            <button type="button" class="btn btn-primary" id="sshSetupOk">OK</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/settings.auth.js') }}"></script>

<!-- Glances scripts -->
<script src="{{ url_for('static', filename='js/glances.common.js') }}?v=12"></script>
<script src="{{ url_for('static', filename='js/glances.install.js') }}?v=12"></script>
<script src="{{ url_for('static', filename='js/glances.uninstall.js') }}?v=12"></script>
<script src="{{ url_for('static', filename='js/glances.service.js') }}?v=13"></script>

<script src="{{ url_for('static', filename='js/software.js') }}"></script>
<script src="{{ url_for('static', filename='js/settings.profiles.js') }}?v=8"></script>
<script src="{{ url_for('static', filename='js/settings.ssh-status.js') }}?v=9"></script>
{% endblock %}