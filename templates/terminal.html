{% extends "base.html" %}

{% block content %}
<h1 class="terminal-title">Terminal to Linux</h1>

<!-- Terminal block -->
<section class="card term-card">
    <div id="terminal"></div>
    <div class="term-toolbar">
        <button id="stop-process-btn">ðŸ›‘ Stop active process (Ctrl + C)</button>
        <span class="terminal-hint">
            Use <strong>Ctrl + C</strong> to stop. Use <strong>Ctrl + Shift + V</strong> to paste.
        </span>
    </div>
</section>

<!-- KeePass Vault Setup -->
<section class="card" id="kp-setup">
  <div class="card-header flex items-center justify-between" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;" data-toggle="collapse" data-target="#kp-setup-body">
    <h3 class="card-title">KeePass Vault Setup</h3>
    <div class="kp-right" style="display:flex;align-items:center;gap:8px;">
      <button id="kp-expand-toggle" class="btn btn-link" type="button">Expand</button>
      <span id="kp-status-badge" class="badge badge-secondary">Not started</span>
    </div>
  </div>
  <div id="kp-setup-body" class="collapse" style="display:none;">
    <p class="mt-2 text-sm text-muted">Provision a local-only SMB share on your Raspberry Pi for storing a KeePassXC .kdbx vault. Runs in safe, small phases with logs and rollback.</p>

    <div class="accordion mt-3" id="kp-phase-accordion">
      <!-- Phase 1 -->
      <div class="accordion-item">
        <h4 class="accordion-header">
          <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#kp-phase1">Phase 1 â€“ Deps &amp; User &amp; Folder</button>
        </h4>
        <div id="kp-phase1" class="accordion-collapse collapse">
          <div class="accordion-body">
            <div class="grid grid-cols-2 gap-3 mb-2" style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:8px;">
              <label class="text-sm">LAN_SUBNET
                <input id="kp-lan-subnet" type="text" class="input" value="192.168.1.0/24">
                <div id="kp-lan-hint" class="text-xs text-muted"></div>
              </label>
              <label class="text-sm">SMB_PASS (required for Phase 2)
                <input id="kp-smb-pass" type="password" class="input" placeholder="Required to run Phase 2">
                <div class="text-xs" style="margin-top:4px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <button id="kp-smb-gen" type="button" class="btn btn-secondary btn-sm">Generate</button>
                  <button id="kp-smb-copy" type="button" class="btn btn-link btn-sm">Copy</button>
                  <button id="kp-smb-toggle" type="button" class="btn btn-link btn-sm">Show</button>
                  <label class="text-xs" style="display:flex;gap:6px;align-items:center;">
                    Length
                    <select id="kp-smb-len" class="input" style="width:84px;padding:2px 6px;">
                      <option>8</option>
                      <option>12</option>
                      <option selected>16</option>
                      <option>24</option>
                      <option>32</option>
                      <option>48</option>
                      <option>64</option>
                    </select>
                  </label>
                  <span id="kp-smb-hint" class="text-xs text-muted"></span>
                </div>
              </label>
              <label class="text-sm">Confirm SMB_PASS
                <input id="kp-smb-pass2" type="password" class="input" placeholder="Re-enter SMB password">
              </label>
              <label class="text-sm" title="If your Pi user is not configured for passwordless sudo, enter the sudo password so setup can install packages and configure services.">SUDO_PASS (optional)
                <input id="kp-sudo-pass" type="password" class="input" placeholder="Needed if sudo prompts">
                <div class="text-xs text-muted">If omitted, we check for passwordless sudo and stop with a clear error if required.</div>
              </label>
            </div>
            <button id="kp-run-phase1" class="btn btn-primary">Run Phase 1</button>
            <span id="kp-phase1-result" class="ml-2 text-sm"></span>
            <pre id="kp-log-phase1" class="log mt-2"></pre>
          </div>
        </div>
      </div>

      <!-- Phase 2 -->
      <div class="accordion-item">
        <h4 class="accordion-header">
          <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#kp-phase2">Phase 2 â€“ Samba Share</button>
        </h4>
        <div id="kp-phase2" class="accordion-collapse collapse">
          <div class="accordion-body">
            <button id="kp-run-phase2" class="btn btn-primary">Run Phase 2</button>
            <span id="kp-phase2-result" class="ml-2 text-sm"></span>
            <pre id="kp-log-phase2" class="log mt-2"></pre>
          </div>
        </div>
      </div>

      <!-- Phase 3 -->
      <div class="accordion-item">
        <h4 class="accordion-header">
          <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#kp-phase3">Phase 3 â€“ Firewall (LAN-only)</button>
        </h4>
        <div id="kp-phase3" class="accordion-collapse collapse">
          <div class="accordion-body">
            <button id="kp-run-phase3" class="btn btn-primary">Run Phase 3</button>
            <span id="kp-phase3-result" class="ml-2 text-sm"></span>
            <pre id="kp-log-phase3" class="log mt-2"></pre>
          </div>
        </div>
      </div>

      <!-- Phase 4 -->
      <div class="accordion-item">
        <h4 class="accordion-header">
          <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#kp-phase4">Phase 4 â€“ Verify</button>
        </h4>
        <div id="kp-phase4" class="accordion-collapse collapse">
          <div class="accordion-body">
            <button id="kp-run-phase4" class="btn btn-primary">Run Phase 4</button>
            <span id="kp-phase4-result" class="ml-2 text-sm"></span>
            <pre id="kp-log-phase4" class="log mt-2"></pre>
          </div>
        </div>
      </div>

      <!-- Rollback -->
      <div class="accordion-item">
        <h4 class="accordion-header">
          <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#kp-rollback">Rollback</button>
        </h4>
        <div id="kp-rollback" class="accordion-collapse collapse">
          <div class="accordion-body">
            <button id="kp-run-rollback" class="btn btn-danger">Run Rollback</button>
            <span id="kp-rollback-result" class="ml-2 text-sm"></span>
            <pre id="kp-log-rollback" class="log mt-2"></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- Windows helper -->
    <div class="mt-4">
      <button class="btn btn-link p-0" data-bs-toggle="collapse" data-bs-target="#kp-windows-helper">Windows mapping helper</button>
      <div id="kp-windows-helper" class="collapse">
        <p class="text-sm text-muted mt-2">Map the SMB share on Windows 11:</p>
        <pre id="kp-win-ps" class="log"></pre>
        <button id="kp-copy-ps" class="btn btn-secondary mt-1">Copy</button>
      </div>
    </div>
  </div>
</section>

<!-- Commands block (full width under terminal) -->
<section class="card cmds-card">
    <header class="cmds-header">
        <div class="title-wrap">
            <h2>Your Command Overview</h2>
            <span id="cmd-count" class="muted"></span>
        </div>
        <input type="text" id="search-box" placeholder="Filterâ€¦">
    </header>

    <div class="cmds-table">
        <div class="cmds-head">
            <div>Title</div>
            <div>Command</div>
            <div>Description</div>
            <div class="actions-col">Action</div>
        </div>
        <div id="command-list" class="cmds-body"></div>
    </div>

    <form id="add-command-form" class="cmds-form">
        <input type="text" id="cmd-title" placeholder="Name (e.g. Reboot)" required>
        <input type="text" id="cmd-command" placeholder="Command (e.g. sudo reboot)" required>
        <input type="text" id="cmd-desc" placeholder="Description (optional)">
        <button type="submit">Add</button>
    </form>

    <p class="muted hint">
        Tip: Click a command cell to <strong>Insert</strong> into the prompt. Use <strong>Run</strong> to send with
        Enter.
        First load includes examples: Reboot, Show memory, Show disk usage.
    </p>
</section>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/xterm/xterm.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/terminal.css') }}">

<script src="{{ url_for('static', filename='js/xterm/xterm.js') }}"></script>
<script src="{{ url_for('static', filename='js/xterm/xterm-addon-fit.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/xterm/xterm-addon-canvas.min.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/socket.io/client-dist/socket.io.js"></script>
<script src="{{ url_for('static', filename='js/terminal.js') }}"></script>
<script>
  (function(){
    // Basic collapse toggles (minimal, no bootstrap dependency)
    const header = document.querySelector('#kp-setup .card-header');
    const body = document.getElementById('kp-setup-body');
    const toggleBtn = document.getElementById('kp-expand-toggle');
    const LS_KEY = 'kpSetupExpanded';
    let expanded = true; // default to expanded on first load

    function setExpanded(v){
      expanded = !!v;
      body.style.display = expanded ? 'block' : 'none';
      if (toggleBtn) toggleBtn.textContent = expanded ? 'Collapse' : 'Expand';
      try { localStorage.setItem(LS_KEY, expanded ? '1' : '0'); } catch {}
    }

    // Initial state from localStorage (fallback to expanded if unset)
    try {
      const v = localStorage.getItem(LS_KEY);
      if (v === '1') expanded = true; else if (v === '0') expanded = false;
    } catch {}
    setExpanded(expanded);

    // Click on header toggles (except on the toggle button)
    if (header && body) header.addEventListener('click', (e) => {
      const t = e.target;
      const isToggle = !!(t && ((t.id === 'kp-expand-toggle') || (t.closest && t.closest('#kp-expand-toggle'))));
      if (isToggle) return;
      setExpanded(!expanded);
    });
    if (toggleBtn) toggleBtn.addEventListener('click', (e) => { e.preventDefault(); setExpanded(!expanded); });
    document.querySelectorAll('#kp-setup [data-bs-toggle="collapse"]').forEach(btn => {
      const t = btn.getAttribute('data-bs-target');
      const el = t ? document.querySelector(t) : null;
      if (!el) return;
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
      });
    });

    const hostName = {{ (settings.pi_host or '"pi"')|tojson }};
    function psHelperText(){
      return [
        `$pi = "${hostName}"`,
        `$drive = "K:"`,
        'New-PSDrive -Name $drive.TrimEnd(\':\') -PSProvider FileSystem -Root "\\\\' + hostName + '\\keepass" -Persist -Credential (New-Object System.Management.Automation.PSCredential("keepass",(Read-Host -AsSecureString "SMB password")))',
      ].join('\n');
    }
    const psEl = document.getElementById('kp-win-ps');
    if (psEl) psEl.textContent = psHelperText();
    const copyPsBtn = document.getElementById('kp-copy-ps');
    if (copyPsBtn) copyPsBtn.onclick = () => navigator.clipboard.writeText(psHelperText());

    function suggestSubnetFromHost(ip){
      const m = /^([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.[0-9]{1,3}$/.exec(ip||'');
      if (!m) return '';
      const a = +m[1], b = +m[2], c = +m[3];
      if (a>255||b>255||c>255) return '';
      return `${a}.${b}.${c}.0/24`;
    }

    function passwordStrengthMsg(pw){
      if (!pw) return '';
      const len = pw.length;
      const hasLower = /[a-z]/.test(pw);
      const hasUpper = /[A-Z]/.test(pw);
      const hasDigit = /[0-9]/.test(pw);
      const hasSym = /[^A-Za-z0-9]/.test(pw);
      const categories = [hasLower, hasUpper, hasDigit, hasSym].filter(Boolean).length;
      if (len < 8 || categories < 2) return 'Weak: use 8+ chars incl. letters and numbers';
      if (len >= 12 && categories >= 3) return 'Strong';
      return 'Medium';
    }

    // Init: auto-suggest LAN_SUBNET from Pi host IP and attach password strength hints.
    (function initHints(){
      const lanEl = document.getElementById('kp-lan-subnet');
      const lanHint = document.getElementById('kp-lan-hint');
      const suggested = suggestSubnetFromHost(hostName);
      if (lanEl && suggested){
        const cur = (lanEl.value||'').trim();
        if (!cur || cur === '192.168.1.0/24') lanEl.value = suggested;
        if (lanHint) lanHint.textContent = `Suggested from Pi IP (${hostName}): ${suggested}`;
      }
      const pwEl = document.getElementById('kp-smb-pass');
      const pwHint = document.getElementById('kp-smb-hint');
      if (pwEl && pwHint){
        const update = () => { pwHint.textContent = passwordStrengthMsg(pwEl.value); };
        pwEl.addEventListener('input', update);
        update();
      }
    })();

    // Secure password generator and helpers
    function randInt(max){
      const a = new Uint32Array(1); window.crypto.getRandomValues(a); return a[0] % max;
    }
    function shuffle(arr){
      for (let i = arr.length - 1; i > 0; i--) { const j = randInt(i + 1); [arr[i], arr[j]] = [arr[j], arr[i]]; }
      return arr;
    }
    function genPassword(len=16){
      const lowers = 'abcdefghijkmnopqrstuvwxyz'; // no l
      const uppers = 'ABCDEFGHJKLMNPQRSTUVWXYZ';  // no O/I
      const digits = '23456789';                  // no 0/1
      const symbols = '!@#$%^*_+-=?';
      const pools = [lowers, uppers, digits, symbols];
      const out = [];
      // Ensure at least one from each pool
      for (const p of pools) out.push(p[randInt(p.length)]);
      const all = pools.join('');
      while (out.length < len) out.push(all[randInt(all.length)]);
      return shuffle(out).join('');
    }
    const genBtn = document.getElementById('kp-smb-gen');
    const pwdCopyBtn = document.getElementById('kp-smb-copy');
    const pwdToggleBtn = document.getElementById('kp-smb-toggle');
    const lenSel = document.getElementById('kp-smb-len');
    if (genBtn){
      genBtn.onclick = () => {
        let L = parseInt(lenSel?.value || '16', 10);
        if (!Number.isFinite(L)) L = 16; if (L < 8) L = 8; if (L > 64) L = 64;
        const v = genPassword(L);
        const p1 = document.getElementById('kp-smb-pass');
        const p2 = document.getElementById('kp-smb-pass2');
        if (p1) p1.value = v;
        if (p2) p2.value = v;
        const hint = document.getElementById('kp-smb-hint');
        if (hint) hint.textContent = passwordStrengthMsg(v);
      };
    }
    if (pwdCopyBtn){
      pwdCopyBtn.onclick = async () => {
        const v = (document.getElementById('kp-smb-pass')?.value || '').trim();
        if (!v) return;
        try { await navigator.clipboard.writeText(v); } catch {}
      };
    }
    if (pwdToggleBtn){
      pwdToggleBtn.onclick = () => {
        const p1 = document.getElementById('kp-smb-pass');
        const p2 = document.getElementById('kp-smb-pass2');
        const shown = p1?.type === 'text';
        if (p1) p1.type = shown ? 'password' : 'text';
        if (p2) p2.type = shown ? 'password' : 'text';
        pwdToggleBtn.textContent = shown ? 'Show' : 'Hide';
      };
    }

    async function runPhase(phase, body, logEl, resultEl){
      resultEl.textContent = 'Running...';
      logEl.textContent = '';
      const res = await fetch(`/api/keepass/setup/${phase}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}) });
      if (!res.ok) {
        let msg = `HTTP ${res.status}`;
        try { const e = await res.json(); if (e && e.error) msg = `Error: ${e.error}`; } catch {}
        resultEl.textContent = msg; return;
      }
      const data = await res.json();
      const { run_id } = data;
      let finished = false, exit_code = null;
      while (!finished){
        const pr = await fetch(`/api/keepass/setup/progress/${run_id}`);
        const pd = await pr.json();
        logEl.textContent = pd.log || '';
        try { logEl.scrollTop = logEl.scrollHeight; } catch {}
        finished = !!pd.finished;
        exit_code = pd.exit_code;
        if (!finished) await new Promise(r => setTimeout(r, 800));
      }
      if (exit_code === 0) {
        resultEl.textContent = 'OK';
      } else {
        const emsg = (typeof pd !== 'undefined' && pd && pd.error) ? String(pd.error) : '';
        resultEl.textContent = emsg ? `Error: ${emsg}` : `Exit ${exit_code}`;
      }
      const badge = document.getElementById('kp-status-badge');
      if (phase === 'phase4' && exit_code === 0){
        badge.textContent = 'Ready'; badge.className = 'badge badge-success';
      } else if (exit_code !== 0){
        badge.textContent = 'Error'; badge.className = 'badge badge-danger';
      } else {
        badge.textContent = 'Not started'; badge.className = 'badge badge-secondary';
      }
    }

    const g = (id) => document.getElementById(id);
    if (g('kp-run-phase1')) g('kp-run-phase1').onclick = () => runPhase('phase1', { env:{ LAN_SUBNET: g('kp-lan-subnet').value || '192.168.1.0/24', SMB_PASS: g('kp-smb-pass').value || '', SUDO_PASS: g('kp-sudo-pass').value || '' } }, g('kp-log-phase1'), g('kp-phase1-result'));
    if (g('kp-run-phase2')) g('kp-run-phase2').onclick = () => {
      const pwd = (g('kp-smb-pass').value || '').trim();
      const pwd2 = (g('kp-smb-pass2')?.value || '').trim();
      const resEl = g('kp-phase2-result');
      if (!pwd) { resEl.textContent = 'SMB_PASS is required for Phase 2'; g('kp-smb-pass').focus(); return; }
      if (pwd2 && pwd !== pwd2) { resEl.textContent = 'Passwords do not match'; g('kp-smb-pass2').focus(); return; }
      const msg = passwordStrengthMsg(pwd);
      if (msg.startsWith('Weak')) { resEl.textContent = msg; g('kp-smb-pass').focus(); return; }
      runPhase('phase2', { env:{ LAN_SUBNET: g('kp-lan-subnet').value || '192.168.1.0/24', SMB_PASS: pwd, SUDO_PASS: g('kp-sudo-pass').value || '' } }, g('kp-log-phase2'), resEl);
    };
    if (g('kp-run-phase3')) g('kp-run-phase3').onclick = () => runPhase('phase3', { env:{ LAN_SUBNET: g('kp-lan-subnet').value || '192.168.1.0/24', SUDO_PASS: g('kp-sudo-pass').value || '' } }, g('kp-log-phase3'), g('kp-phase3-result'));
    if (g('kp-run-phase4')) g('kp-run-phase4').onclick = () => runPhase('phase4', {}, g('kp-log-phase4'), g('kp-phase4-result'));
    if (g('kp-run-rollback')) g('kp-run-rollback').onclick = () => runPhase('rollback', {}, g('kp-log-rollback'), g('kp-rollback-result'));
  })();
</script>
{% endblock %}
